# go-auth-workload

This is an example to explain the mechanism by which your workload integrates with other clouds through OIDC.  
It is the same mechanism that allows for deployment to public clouds like AWS via OIDC with GitHub Actions.

> [!NOTE]
> This project is solely for the purpose of providing a simplified explanation and it is NOT RECOMMENDED to use this code in a production environment.

## Requirements

```shell
openssl genrsa -out private-key.pem
openssl rsa -in private-key.pem -pubout -out public-key.pem
```

## Build

```shell
make build
```

## Run

1. Start the OIDC provider

This is a server with a role similar to GitHub Actions, and it generates OIDC tokens at the `/token` endpoint.

```shell
./bin/go-auth-workload oidc-provider
```

```shell
curl -s 'http://localhost:8080/token?aud=test' | jq -r .token | decode-jwt | jq -r
[
  {
    "iss": "http://localhost:8080",
    "sub": "acme-workload-system-worker",
    "aud": "test",
    "iat": 1699281266,
    "exp": 1699281566
  },
  {
    "alg": "RS256",
    "kid": "123456789",
    "typ": "JWT"
  }
]
```

2. Start cloud provider

This is a server with a similar to AWS, with integration via OIDC already configured.

```shell
./bin/go-auth-workload cloud-provider
```

When you send a token generated by the oidc-provider, an STS token is generated.

```shell
curl -d (curl -s 'http://localhost:8080/token?aud=sts.cloud.example.com') http://localhost:9090/sts
{"token":"sts_06661f03fad57b1297460c3c201248b1"}
```

When you send an STS Token to the cloud, you can obtain an Access Token.


```shell
curl -s -d (curl -s -d (curl -s 'http://localhost:8080/token?aud=sts.cloud.example.com') http://localhost:9090/sts) http://localhost:9090/access-token
{"token":"access_token_4a0b25fa22c0eaaa2cdc6a74e13d518c"}
```

3. Launching the client that executes the workload.

The client subcommand is a workload client that automates the entire process thus far, exchanging OIDC Tokens for STS Tokens and STS Tokens for Access Tokens.

```shell
./bin/go-auth-workload client
2023/11/06 23:46:38 INFO successfully get sts token token=sts_0c53cdbee3bd4cac2ca2f2ff54ae733c
2023/11/06 23:46:38 INFO successfully get access token token=access_token_d40c429e4d2d5160562828985b0bbc07
```
